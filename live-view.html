<head>
  <script src="js/filesaver.js"></script>
  <script src="js/liveview.js"></script>
  <script src="js/serial.js"></script>

</head>

<body>

  <h1>Davis 6410 Live View v0.0.1</h1>

  <p>
    <button onclick="connect()">connect</button>
    <button onclick="disconnect()">disconnect</button>
    <span>&nbsp;&nbsp;&nbsp;</span>
    <input type="file" id="file-selector">
    <button onclick="traceView.save()">save</button>

  </p>
  
  <canvas id='trace-view' width=1000 height=600 style='background-color: red;'></canvas>

  <p>
    <span>&nbsp;&nbsp;&nbsp;</span>
    <button onclick="startSample()">sample</button>
    <span>&nbsp;&nbsp;&nbsp;</span>
    <span>&nbsp;&nbsp;&nbsp;</span>
    <span>&nbsp;&nbsp;&nbsp;</span>
    <span>timebase</span>
    <button onclick="traceView.redraw({timebase:1});">1ms</button>
    <button onclick="traceView.redraw({timebase:10});">10ms</button>
    <button onclick="traceView.redraw({timebase:20});">20ms</button>
    <button onclick="traceView.redraw({timebase:50});">50ms</button>
    <button onclick="traceView.redraw({timebase:100});">100ms</button>
    <button onclick="traceView.redraw({timebase:200});">200ms</button>
    <button onclick="traceView.redraw({timebase:250});">250ms</button>
    <button onclick="traceView.redraw({timebase:500});">500ms</button>
  </p>

  <script>

    // Creat the serial connection manager.
    // Data sampleos arrive view the serial port.
    const serialConnection = new Serial(processFrameBuffer);

    // Draw the background view and grid.
    const traceView = new TraceView('#trace-view');


    // Cnnect to the serial port and start collecting sample streams.
    function connect() {
      serialConnection.connect();
    }


    function startSample() {
      serialConnection.writeCommand('sample-channel-2\n');
    }


    // Disconnect from the serial port.
    function disconnect() {
      serialConnection.disconnect();
    }

    // Process a frame data.
    // The data is examined to see if it contains a new sample set. If it does,
    // then the samples are extracted and plotted in the live view.
    function processFrameBuffer(frameBuffer) {

      const checkHeader = (buffer, i) =>
        frameBuffer[i + 0] === 39 && frameBuffer[i + 1] === 39 &&
        frameBuffer[i + 2] === 39 && frameBuffer[i + 3] === 36 &&
        frameBuffer[i + 4] === 36 && frameBuffer[i + 5] === 36 &&
        frameBuffer[i + 6] === 0 && frameBuffer[i + 7] === 255;

      // A data frame consists of,
      //    8 byte header
      //    2 byte data length
      //    n data bytes
      //    2 byte data length
      if (frameBuffer.length < 2) return frameBuffer;

      // Look for the rame header.
      for (let i = 0; i < frameBuffer.length - 8; ++i)
        if (!checkHeader(frameBuffer,i))
          frameBuffer.shift();
        else {
          // Found the start of a frame, so read the data size.
          const dataSize = frameBuffer[i + 8] + frameBuffer[i + 9] * 256;

          // Check if we have a complete frame.
          if (frameBuffer.length >= 8 + dataSize) {
            let samples = frameBuffer.slice(8, 8 + dataSize);
            frameBuffer = frameBuffer.slice(8 + dataSize);

            traceView.setSamples(samples, dataSize);
            traceView.drawFrame();
            traceView.drawSamples();
          }

          return frameBuffer;
        }

      // Data does not contain a frame or start of a frame.
      return [];
    }


    const fileSelector = document.getElementById('file-selector');
    fileSelector.addEventListener('change', (event) => {
      const fileList = event.target.files;
      console.log(fileList);
    });



    // Create a test sample set.
    const samples = [];
    for (let i = 0; i < 24000; ++i)
      samples.push(0.5 + 0.5 * Math.sin(2 * Math.PI * i / 24000));

    console.log('done!');

    // Draw the samples with 100ms per major division.
    traceView.drawFrame();

    traceView.setSamples(samples, 24000);
    traceView.drawSamples();



  </script>

</body>
